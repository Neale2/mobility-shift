<!doctype html>
<html lang="en">
    <head>
        {% block title %}
        <title>Dashboard</title>
        {% endblock %}
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- Add additional CSS in static file -->
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
        <link rel="icon" type="image/png" href="{% static 'images/favicon/favicon-96x96.png' %}" sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon/favicon.svg' %}" />
        <link rel="shortcut icon" href="{% static 'images/favicon/favicon.ico' %}" />
        <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicon/apple-touch-icon.png' %}" />
        <meta name="apple-mobile-web-app-title" content="Swap One" />
        <link rel="manifest" href="{% static 'images/favicon/site.webmanifest' %}" />
        <script>
            //grams of CO2e
            const TreePerYear = 54352;
            const Targets = [
                0, 100, 500, 1000, 2500, 5000, 7500, 10000, 12500, 15000, 17500, 20000, 22500, 25000, 30000, 40000,
                50000, 75000, 100000, 125000, 150000, 200000, 250000, 500000, 750000, 1000000, 2500000, 5000000,
                10000000, 25000000, 50000000, 100000000, 250000000, 500000000, 1000000000, 2500000000, 5000000000,
                10000000000, 25000000000, 50000000000, 100000000000, 250000000000, 500000000000, 1000000000000
            ];

            var userName = "{{ user.name }}";
            var userSaved = {{ user.emissions_saved }};
            var userStreak = {{ user.current_streak }};
            var friends = {{ friends_json|safe }};
            var employerName = "{{ employer.name }}";
            var employerSaved = {{ employer.emissions_saved }};
            var regionName = "{{ region.name }}";
            var regionSaved = {{ region.emissions_saved }};
            var allSaved = {{ all.emissions_saved }};

            var prevGoal = 50;
            var targetGoal = 100;

            Targets.forEach(function (target, index) {
                if (target <= userSaved) {
                    targetGoal = Targets[index + 1];
                    prevGoal = target;
                }
            });

            var distToGoal = targetGoal - userSaved;

            var prevGoalEmp = 50;
            var targetGoalEmp = 100;

            Targets.forEach(function (target, index) {
                if (target <= employerSaved) {
                    targetGoalEmp = Targets[index + 1];
                    prevGoalEmp = target;
                }
            });

            var prevGoalReg = 50;
            var targetGoalReg = 100;

            Targets.forEach(function (target, index) {
                if (target <= regionSaved) {
                    targetGoalReg = Targets[index + 1];
                    prevGoalReg = target;
                }
            });

            var prevGoalAll = 50;
            var targetGoalAll = 100;

            Targets.forEach(function (target, index) {
                if (target <= allSaved) {
                    targetGoalAll = Targets[index + 1];
                    prevGoalAll = target;
                }
            });
            addEventListener("DOMContentLoaded", function () {
                console.log(prevGoalEmp);
                var parent = document.getElementById("emissions");
                parent.innerHTML = `
                <div class="emissionsbox">
                    <h4>ðŸ”¥ Your Streak</h4>
                    <div class="yroundbox">
                        <p style="font-size: 2.5em; margin: 10px 0; text-align: center; color: #ff6b47;">${userStreak}</p>
                        <p style="text-align: center; margin: 5px 0;"><strong>${userStreak} week${userStreak !== 1 ? 's' : ''} in a row!</strong></p>
                        <p style="text-align: center; font-size: 0.9em; color: #666;">
                            ${userStreak === 0 ? 'Log a trip this week to start your streak!' : 
                              userStreak === 1 ? 'Great start! Keep it up next week!' :
                              userStreak < 5 ? 'You\'re building momentum! Keep going!' :
                              userStreak < 10 ? 'Fantastic streak! You\'re on fire!' :
                              'Amazing dedication! You\'re a sustainability champion!'}
                        </p>
                    </div>
                </div>
                ` + (friends.length > 0 ? `
                <div class="emissionsbox">
                    <h4>ðŸ‘¥ Friend Streaks</h4>
                    <div class="yroundbox">
                        ${friends.map(friend => `
                            <div style="background-color: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #4CAF50;">
                                <p style="margin: 0; font-weight: bold;">${friend.name}</p>
                                <p style="margin: 2px 0; color: #ff6b47;">ðŸ”¥ ${friend.streak} week${friend.streak !== 1 ? 's' : ''} together</p>
                                <p style="margin: 2px 0; font-size: 0.9em; color: #666;">${(friend.emissions_saved / 1000).toFixed(1)}kg CO2e saved</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="emissionsbox">
                    <h4>ðŸ‘¥ Friends</h4>
                    <div class="yroundbox">
                        <p style="text-align: center; color: #666;">No friends yet! Add friends to track streaks together.</p>
                        <div style="text-align: center; margin-top: 15px;">
                            <input type="email" id="friendEmail" placeholder="Friend's email" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button onclick="sendFriendRequest()" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Friend</button>
                        </div>
                    </div>
                </div>
                `) + `
                <div class="emissionsbox">
                    <h4>You</h4>
                    <div class="graphback">
                        <div class="graphfront" style="width:${((userSaved / targetGoal) * 100).toFixed(1)}%;"></div>
                        <span class="graphlabel" style="left:calc(0% - 200px);">0.0kg</span>
                        <span class="graphlabel" style="left:calc(${((prevGoal / targetGoal) * 100).toFixed(1)}% - 200px);">${(prevGoal / 1000).toFixed(1)}kg</span>
                        <span class="graphlabel" style="left:calc(100% - 200px);">${targetGoal / 1000}kg</span>
                    </div>
                    <div class="yroundbox">
                    <p>You've saved ${(userSaved / 1000).toFixed(1)}kg of CO2e so far.</p>
                    <p>You've hit the milestone of saving ${(prevGoal / 1000).toFixed(1)}kg!</p>
                    <p>Keep up the great work - you're only ${(distToGoal / 1000).toFixed(1)} kilograms away from hitting your next milestone of ${(targetGoal / 1000).toFixed(1)}kg!</p>
                </div></div>
                `;
                if (employerName != "None / Other / Prefer Not To Say") {
                    parent.innerHTML =
                        parent.innerHTML +
                        `
                        <div class="emissionsbox">
                            <h4>${employerName}</h4>
                            <div class="graphback">
                                <div class="graphfront" style="width:${((employerSaved / targetGoalEmp) * 100).toFixed(1)}%;"></div>
                                <span class="graphlabel" style="left:calc(0% - 200px);">0.0kg</span>
                                <span class="graphlabel" style="left:calc(${((prevGoalEmp / targetGoalEmp) * 100).toFixed(1)}% - 200px);">${(prevGoalEmp / 1000).toFixed(1)}kg</span>
                                <span class="graphlabel" style="left:calc(100% - 200px);">${targetGoalEmp / 1000}kg</span>
                            </div>
                            <div class="yroundbox">
                            <p>So far, ${employerName} has saved ${(employerSaved / 1000).toFixed(0)}kg of CO2e.</p>
                            <p>Encourage your coworkers to keep up the great work!</p>
                        </div></div>
                        `;
                }
                if (regionName != "Other") {
                    if (regionName == "Nelson") {
                        parent.innerHTML =
                            parent.innerHTML +
                            `
                        <div class="emissionsbox">
                            <h4>${regionName}</h4>
                            <div class="graphback">
                                <div class="graphfront" style="width:${((regionSaved / targetGoalReg) * 100).toFixed(1)}%;"></div>
                                <span class="graphlabel" style="left:calc(0% - 200px);">0.0kg</span>
                                <span class="graphlabel" style="left:calc(${((prevGoalReg / targetGoalReg) * 100).toFixed(1)}% - 200px);">${(prevGoalReg / 1000).toFixed(1)}kg</span>
                                <span class="graphlabel" style="left:calc(100% - 200px);">${targetGoalReg / 1000}kg</span>
                            </div>
                            <div class="yroundbox">
                            <p>Together, ${regionName} has saved ${(regionSaved / 1000).toFixed(0)}kg of CO2e.</p>
                            <p>Great job, Nelsonians!</p>
                        </div></div>
                        `;
                    } else {
                        parent.innerHTML =
                            parent.innerHTML +
                            `
                        <div class="emissionsbox">
                            <h4>${regionName}</h4>
                            <div class="graphback">
                                <div class="graphfront" style="width:${((regionSaved / targetGoalReg) * 100).toFixed(1)}%;"></div>
                                <span class="graphlabel" style="left:calc(0% - 200px);">0.0kg</span>
                                <span class="graphlabel" style="left:calc(${((prevGoalReg / targetGoalReg) * 100).toFixed(1)}% - 200px);">${(prevGoalReg / 1000).toFixed(1)}kg</span>
                                <span class="graphlabel" style="left:calc(100% - 200px);">${targetGoalReg / 1000}kg</span>
                            </div>
                            <div class="yroundbox">
                            <p>Together, ${regionName} has saved ${(regionSaved / 1000).toFixed(0)}kg of CO2e.</p>
                            <p>Great job, residents of ${regionName}!</p>
                        </div></div>
                        `;
                    }
                }
                parent.innerHTML =
                    parent.innerHTML +
                    `
                        <div class="emissionsbox">
                            <h4>Swap One</h4>
                            <div class="graphback">
                                <div class="graphfront" style="width:${((allSaved / targetGoalAll) * 100).toFixed(1)}%;"></div>
                                <span class="graphlabel" style="left:calc(0% - 200px);">0.0kg</span>
                                <span class="graphlabel" style="left:calc(${((prevGoalAll / targetGoalAll) * 100).toFixed(1)}% - 200px);">${(prevGoalAll / 1000).toFixed(1)}kg</span>
                                <span class="graphlabel" style="left:calc(100% - 200px);">${targetGoalAll / 1000}kg</span>
                            </div>
                            <div class="yroundbox">
                            <p>In total, we've saved ${(allSaved / 1000).toFixed(0)}kg of CO2e.</p>
                            <p>That's as much as ${(allSaved / TreePerYear).toFixed(0)} trees absorb in a year!</p>
                        </div></div>
                        `;

                if (window.location.search.slice(1) == "confirm_edit=true") {
                    alert("Successfully edited profile!");
                }
            });

            function navToggle() {
                var x = document.getElementById("navlinks");
                var y = document.getElementById("navbutton");
                if (x.style.display === "flex") {
                    console.log("a");
                    x.style.display = "none";
                    y.innerHTML = "â˜°";
                } else {
                    x.style.display = "flex";
                    y.innerHTML = "âœ•";
                    console.log("b");
                    console.log("b");
                }
            }
            
            function sendFriendRequest() {
                const email = document.getElementById('friendEmail').value.trim();
                if (!email) {
                    alert('Please enter an email address');
                    return;
                }
                
                fetch(`/friends/send/{{ user.uuid }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `friend_email=${encodeURIComponent(email)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.success);
                        document.getElementById('friendEmail').value = '';
                        location.reload(); // Refresh to show new friend
                    } else {
                        alert(data.error || 'Error sending friend request');
                    }
                })
                .catch(error => {
                    alert('Error sending friend request: ' + error);
                });
            }
            
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>
    </head>
    <body>
        <header>
            <div class="visdiv">
                <button id="navbutton" onclick="navToggle()">â˜°</button>
                <div class="headerbox">
                    <a href="https://www.swapone.nz"><img class="logo" src="{% static 'images/cool_logo.png' %}" /></a>
                </div>
            </div>
            <div id="navlinks">
                <a class="button" href="/edit/{{ user.uuid }}">Edit Profile</a>
                <a class="button" href="/dash/{{ user.uuid }}">View Dashboard</a>
                <a class="button" href="/unsubscribe/{{ user.uuid }}">Unsubscribe</a>
            </div>
        </header>
        <main>
            <h1>Dashboard</h1>
            <h2>Your Info</h2>
            <div class="content" id="emissions"></div>
            <hr class="divider" />
            <div class="content"><div class="article">{{ post.formatted_markdown|safe }}</div></div>
        </main>
        <footer>
            <div class="logobox">
                <a href="https://www.nelsontasmanclimateforum.nz/"
                    ><img class="logoimg" src="{% static 'images/Logos/ntcf.png' %}"
                /></a>
                <a href="https://missionzero.nz/"
                    ><img class="logoimg" src="{% static 'images/Logos/missionzero.png' %}"
                /></a>
                <a href="https://www.nelsust.org.nz/"
                    ><img class="logoimg" src="{% static 'images/Logos/nelsust.png' %}"
                /></a>
                <a href="https://www.nelson.govt.nz/"
                    ><img class="logoimg" src="{% static 'images/Logos/ncc.png' %}"
                /></a>
            </div>
            <p>
                <b>
                    Made with love by Arturo Neale |
                    <a
                        href="https://docs.google.com/document/d/16ZJs5ThK508UCH08u0rqlp89AmkNzo0Klvcf2od-W18/edit?usp=sharing"
                        >Ts & Cs / Privacy Policy</a
                    >
                </b>
            </p>
        </footer>
    </body>
</html>
